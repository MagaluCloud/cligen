name: Sync tmp-cli to tmp-mgccli

on:
  pull_request:
    types:
      - closed
    branches:
      - main
  workflow_dispatch:


permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync tmp-cli to tmp-mgccli
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch' 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'
          cache: true
          cache-dependency-path: |
            **/go.mod
            **/go.sum

      - name: Generate CLI from SDK
        run: make new-run

      - name: Build generated CLI
        run: make run-cli

      - name: Import GPG key
        id: import-gpg-key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.MAGALUBOT_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.MAGALUBOT_GPG_PASSPHRASE }}
        run: |
          # Import the private key with passphrase
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --import

          # Get Key ID and Fingerprint
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | awk '/sec/ {split($2, a, "/"); print a[2]}')
          FINGERPRINT=$(gpg --fingerprint --with-colons $KEY_ID | awk -F: '$1 == "fpr" {print $10; exit}')

          # Trust the key ultimately
          echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

          # Create GPG wrapper script
          mkdir -p ~/bin
          echo '#!/bin/sh' > ~/bin/git-gpg-wrapper
          echo 'echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 "$@"' >> ~/bin/git-gpg-wrapper
          chmod +x ~/bin/git-gpg-wrapper
          echo "$HOME/bin" >> $GITHUB_PATH

          # Set GPG_TTY to avoid warnings
          echo "GPG_TTY=$(tty)" >> $GITHUB_ENV

      - name: Configure Git
        id: config-git
        if: steps.import-gpg-key.outcome == 'success'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.MAGALUBOT_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.MAGALUBOT_GPG_PASSPHRASE }}
        run: |
          git config --global user.email "${{vars.MAGALUBOT_EMAIL}}"
          git config --global user.name "${{vars.MAGALUBOT_USER_NAME}}"
          git config --global commit.gpgsign true
          git config --global tag.gpgsign true
          git config --global gpg.program git-gpg-wrapper
          # Get and set the signing key
          SIGNING_KEY=$(gpg --list-secret-keys --keyid-format LONG | awk '/sec/ {split($2, a, "/"); print a[2]}')
          git config --global user.signingkey $SIGNING_KEY

      - name: Setup GitHub CLI
        id: setup-gh-cli
        uses: ksivamuthu/actions-setup-gh-cli@v3
      
      - name: Checkout tmp-mgccli repository
        uses: actions/checkout@v4
        with:
          repository: MagaluCloud/tmp-mgccli
          path: tmp-mgccli-repo
          token: ${{ secrets.MAGALUBOT_GH_PAT }}
        
      - name: Merge tmp-cli to tmp-mgccli repository
        env:
          GPG_PASSPHRASE: ${{ secrets.MAGALUBOT_GPG_PASSPHRASE }}
          GITHUB_TOKEN: ${{ secrets.MAGALUBOT_GH_PAT }}
        run: |

          # Usar PAT customizado se disponível, caso contrário usar GITHUB_TOKEN
          TOKEN="${GITHUB_TOKEN}"
          
          # Criar nome da branch baseado no número do PR e commit SHA
          RANDOM_STRING=$(openssl rand -hex 8)
          BRANCH_NAME="merge-cligen-${RANDOM_STRING}"
          # Remover caracteres especiais do nome da branch
          BRANCH_NAME=$(echo "$BRANCH_NAME" | tr -cd '[:alnum:]-_')
          
          # Entrar no repositório clonado
          cd tmp-mgccli-repo
          
          # Criar e fazer checkout de uma nova branch
          git switch -c "${BRANCH_NAME}"
          
          # Remover todos os arquivos existentes (exceto .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copiar todo o conteúdo de tmp-cli para o repositório
          cp -r ../tmp-cli/* .
          cp -r ../tmp-cli/.[!.]* . 2>/dev/null || true
          
          # Adicionar todos os arquivos
          git add -A
          
          # Verificar se há mudanças para commitar
          if git diff --staged --quiet; then
            echo "Nenhuma mudança para commitar"
          else
            echo "Fazendo commit"
            # Fazer commit
            git commit -m "PR #${{ github.event.pull_request.number }} - Merge tmp-cli from cligen"
            
            echo "Fazendo push"
            # Fazer push da branch (actions/checkout já configurou a autenticação)
            git push origin "${BRANCH_NAME}"
            
            # Criar Pull Request usando a CLI do GitHub
            echo "Criando Pull Request"
            cd ..
            
            gh pr create \
              --repo MagaluCloud/tmp-mgccli \
              --base main \
              --head "${BRANCH_NAME}" \
              --title "Merge tmp-cli from cligen PR #${{ github.event.pull_request.number }}" \
              --body "Automatically created by workflow #${{ github.event.pull_request.number }} from cligen main"
            echo "Pull Request criado com sucesso"
          fi

